<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context Manager</title>
    <style>
        :root {
            --vscode-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --vscode-editor-foreground: #cccccc;
            --vscode-side-bar-background: #252526;
            --vscode-button-background: #0e639c;
            --vscode-button-foreground: #ffffff;
            --vscode-button-hover-background: #1177bb;
            --vscode-button-secondary-background: #5a5a5a;
            --vscode-button-secondary-foreground: #cccccc;
            --vscode-button-secondary-hover-background: #6a6a6a;
            --vscode-editor-widget-border: #454545;
            --vscode-description-foreground: #9d9d9d;
            --vscode-input-background: #3c3c3c;
            --vscode-input-foreground: #cccccc;
            --vscode-focus-border: #007acc;
            --vscode-icon-foreground: #cccccc;
            --vscode-error-foreground: #f85149;
            --vscode-editor-font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            --vscode-editor-font-size: 13px;
            --vscode-success-foreground: #3fb950;
        }

        body {
            font-family: var(--vscode-font-family);
            color: var(--vscode-editor-foreground);
            background-color: var(--vscode-side-bar-background);
            margin: 0;
            padding: 16px;
            font-size: 13px;
        }

        .header {
            margin-bottom: 20px;
        }

        .header h2 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--vscode-editor-foreground);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 8px 12px;
            border: 1px solid var(--vscode-button-background);
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
        }

        .btn:hover {
            background-color: var(--vscode-button-hover-background);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: var(--vscode-button-secondary-background);
            color: var(--vscode-button-secondary-foreground);
            border-color: var(--vscode-button-secondary-background);
        }

        .btn-secondary:hover {
            background-color: var(--vscode-button-secondary-hover-background);
        }

        .btn-toggle {
            background-color: var(--vscode-button-secondary-background);
            color: var(--vscode-button-secondary-foreground);
            border-color: var(--vscode-button-secondary-background);
        }

        .btn-toggle:hover {
            background-color: var(--vscode-button-secondary-hover-background);
        }

        .btn-toggle.active {
            background-color: #007acc;
            color: #ffffff;
            border-color: var(--vscode-success-foreground);
        }

        .btn-toggle.active:hover {
            background-color: #74c9fe;
        }

        .toggle-indicator {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--vscode-success-foreground);
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .btn-toggle.active .toggle-indicator {
            opacity: 1;
        }

        .clear-all-container {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--vscode-editor-widget-border);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .copy-all-full {
            width: 100%;
            height: calc(1.5 * 32px);
            font-size: 1.2em;
        }

        .clear-all-full {
            width: 100%;
        }

        .context-container {
            background-color: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
        }

        .context-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--vscode-description-foreground);
            font-size: 14px;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .context-item {
            position: relative;
            border-bottom: 1px solid var(--vscode-editor-widget-border);
            transition: background-color 0.15s ease;
        }

        .btn-col {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            height: 100%;
        }

        .context-item:last-child {
            border-bottom: none;
        }

        .context-item:hover {
            background-color: rgba(255, 255, 255, 0.03);

            .context-item:first-child {
                border-top-left-radius: 6px;
                border-top-right-radius: 6px;
            }

            .context-item:last-child {
                border-bottom-left-radius: 6px;
                border-bottom-right-radius: 6px;
                border-bottom: none;
            }
        }

        .item-content {
            padding: 8px;
        }

        .item-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            flex-shrink: 0;
        }

        .badge-file {
            background: linear-gradient(135deg, #007acc, #005a9e);
        }

        .badge-url {
            background: linear-gradient(135deg, #3f883f, #2d632d);
        }

        .badge-text {
            background: linear-gradient(135deg, #c85022, #a03e19);
        }

        .item-source {
            color: var(--vscode-description-foreground);
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
            direction: rtl;
            text-align: left;
        }

        .web-item-source {
            color: var(--vscode-description-foreground);
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }

        .delete-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(248, 81, 73, 0.1);
            color: var(--vscode-error-foreground);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0;
            transition: all 0.15s ease;
            z-index: 2;
            margin-top: 4px;
        }

        .context-item:hover .delete-btn {
            opacity: 1;
        }

        /* Only show main-btn on hover if not main, always show if main */
        .context-item:hover .delete-btn {
            opacity: 1;
        }

        .context-item.main-context {
            border-left: 3px solid var(--vscode-focus-border);
        }

        .main-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(0, 122, 204, 0.1);
            color: var(--vscode-focus-border);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 4px;
            opacity: 0;
            transition: all 0.15s ease;
            z-index: 2;
        }

        .main-btn.main-active {
            background: rgba(0, 122, 204, 0.2);
            color: var(--vscode-focus-border);
            opacity: 1 !important;
        }

        .context-item:hover .main-btn:not(.main-active) {
            opacity: 1;
        }

        .main-btn:not(.main-active) {
            opacity: 0;
        }

        .main-btn:hover {
            background: rgba(0, 122, 204, 0.2);
        }

        .main-badge {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 8px;
            color: var(--vscode-focus-border);
            border: 1px solid var(--vscode-focus-border);
            margin-left: auto;
        }

        .delete-btn:hover {
            background: rgba(248, 81, 73, 0.2);
        }

        .ignore-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(157, 157, 157, 0.1);
            color: var(--vscode-description-foreground);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin-bottom: 4px;
            opacity: 0;
            transition: all 0.15s ease;
            z-index: 2;
        }

        .context-item:hover .ignore-btn:not(.ignored-active) {
            opacity: 1;
        }

        .ignore-btn:hover {
            background: rgba(157, 157, 157, 0.2);
        }

        .ignore-btn.ignored-active {
            background: rgba(157, 157, 157, 0.2);
            color: var(--vscode-description-foreground);
            opacity: 1 !important;
        }

        .context-item.ignored .editable-text {
            opacity: 0.5;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .editable-text {
            width: 100%;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-editor-widget-border);
            border-radius: 4px;
            padding: 12px;
            font-family: var(--vscode-editor-font-family);
            font-size: var(--vscode-editor-font-size);
            resize: vertical;
            min-height: 80px;
            box-sizing: border-box;
            transition: border-color 0.15s ease;
        }

        .editable-text:focus {
            outline: none;
            border-color: var(--vscode-focus-border);
            box-shadow: 0 0 0 1px var(--vscode-focus-border);
        }

        .editable-text::placeholder {
            color: var(--vscode-description-foreground);
            opacity: 0.7;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: rgba(255, 255, 255, 0.02);
            border-top: 1px solid var(--vscode-editor-widget-border);
            font-size: 12px;
            color: var(--vscode-description-foreground);
        }

        .btn-icon::before {
            content: '';
            width: 14px;
            height: 14px;
            background-size: contain;
            display: inline-block;
        }

        .icon-file::before {
            content: '📁';
        }

        .icon-url::before {
            content: '🌐';
        }

        .icon-text::before {
            content: '📝';
        }

        .icon-search::before {
            content: '🔍';
        }

        .icon-clear::before {
            content: '🗑️';
        }

        .icon-copy::before {
            content: '📋';
        }

        .suggestion-wrapper {
            position: relative;
        }

        .suggestion-box {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            min-width: 180px;
            border: 1px solid var(--vscode-focus-border);
            background-color: var(--vscode-input-background);
            z-index: 100;
            max-height: 150px;
            overflow-y: auto;
            border-radius: 4px;
            margin-top: 2px;
        }

        .suggestion-item {
            padding: 6px 12px;
            cursor: pointer;
            color: var(--vscode-input-foreground);
            font-family: var(--vscode-editor-font-family);
            font-size: var(--vscode-editor-font-size);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .suggestion-item.selected {
            background-color: var(--vscode-focus-border);
            color: var(--vscode-button-foreground);
        }

        .project-tree-container {
            background-color: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            overflow-y: auto;
            max-height: 400px;
            border: 1px solid var(--vscode-editor-widget-border);
            padding: 8px;
        }

        .tree-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Make indentation work by adding padding to nested lists.
        This is the key to making it look like a tree. */
        .tree-item .tree-list {
            padding-left: 24px;
        }

        .tree-item-content {
            display: flex;
            align-items: center;
            padding: 4px;
            cursor: pointer;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tree-item-content:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .tree-item-content label {
            display: flex;
            align-items: center;
            cursor: pointer;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tree-item-content input[type="checkbox"] {
            margin-right: 8px;
            flex-shrink: 0;
        }

        .tree-item-name {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Add file/folder icons before the name for proper alignment */
        .tree-item-name::before {
            margin-right: 6px;
            font-family: var(--vscode-font-family);
        }

        .tree-item.folder .tree-item-name::before {
            content: '📁';
        }

        .tree-item.file .tree-item-name::before {
            content: '📄';
        }

        .tree-icon {
            margin-right: 6px;
            width: 10px;
            /* Adjusted width */
            text-align: center;
            flex-shrink: 0;
        }

        /* Chevron for FOLDERS only */
        .tree-item.folder>.tree-item-content .tree-icon::before {
            content: '▶';
            display: inline-block;
            transition: transform 0.15s ease-in-out;
            font-size: 10px;
        }

        .tree-item.folder.open>.tree-item-content .tree-icon::before {
            transform: rotate(90deg);
        }

        /* The misaligned ::after rules are now removed */

        .tree-children {
            display: none;
        }

        .tree-item.open>.tree-children {
            display: block;
        }

        .jump-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--vscode-button-secondary-background);
            color: var(--vscode-button-foreground);
            border: 1px solid var(--vscode-editor-widget-border);
            cursor: pointer;
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 1000;
        }

        .jump-btn:hover {
            background-color: var(--vscode-button-secondary-hover-background);
        }

        #jump-to-top-btn {
            bottom: 70px;
            /* Position it above the bottom button */
        }

        /* --- Tab Styles --- */
        .tabs-container {
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--vscode-editor-widget-border);
            margin-bottom: 16px;
            padding-bottom: 4px;
            gap: 4px;
            overflow-x: auto;
        }

        .tabs-list {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            flex-grow: 1;
        }

        .tab-item {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            gap: 8px;
            white-space: nowrap;
        }

        .tab-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .tab-item.active {
            background-color: var(--vscode-side-bar-background);
            border-color: var(--vscode-editor-widget-border);
            border-bottom: 1px solid var(--vscode-side-bar-background);
            color: var(--vscode-editor-foreground);
            margin-bottom: -1px;
        }

        .tab-name {
            font-size: 13px;
        }

        .tab-name-input {
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-focus-border);
            border-radius: 2px;
            padding: 2px 4px;
            font-size: 13px;
            width: 100px;
        }

        .close-tab-btn {
            background: none;
            border: none;
            color: var(--vscode-description-foreground);
            cursor: pointer;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }

        .close-tab-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            opacity: 1;
        }

        #add-tab-btn {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            background-color: transparent;
            color: var(--vscode-icon-foreground);
        }

        #add-tab-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>
    <div class="tabs-container">
        <ul id="tabs-list" class="tabs-list"></ul>
        <button id="add-tab-btn" title="New Tab">+</button>
    </div>
    <div class="header">
        <div class="controls">
            <button class="btn icon-file" id="add-file-btn">
                <span>File</span>
            </button>
            <button class="btn icon-url" id="add-url-btn">
                <span>URL</span>
            </button>
            <button class="btn icon-text" id="add-text-btn">
                <span>Text</span>
            </button>
            <button class="btn btn-toggle icon-search" id="web-search-toggle">
                <span>Web Search</span>
                <div class="toggle-indicator"></div>
            </button>
        </div>
    </div>
    <div class="header" style="margin-top: 20px;">
        <h2>Project Files</h2>
    </div>
    <div id="project-tree-container" class="project-tree-container">
        <p class="empty-state">Loading project files...</p>
    </div>

    <div class="header" style="margin-top: 20px;">
        <h2>Context Items</h2>
    </div>
    <div class="context-container">
        <ul class="context-list" id="context-list">
        </ul>
        <div class="stats">
            <span>3 context items</span>
            <span id="search-status">Web search: OFF</span>
        </div>
    </div>

    <div class="clear-all-container">
        <button class="btn btn-secondary icon-copy copy-all-full" id="copy-all-btn">
            <span>Copy All</span>
        </button>
        <button class="btn btn-secondary copy-all-full" id="gemini-btn">
            <span>Gemini</span>
        </button>
        <button class="btn btn-secondary copy-all-full" id="glm-btn">
            <span>GLM-4.5</span>
        </button>
        <button class="btn btn-secondary icon-clear clear-all-full" id="clear-all-btn">
            <span>Clear All</span>
        </button>
    </div>

    <button id="jump-to-top-btn" class="jump-btn" title="Jump to Top">▲</button>
    <button id="jump-to-bottom-btn" class="jump-btn" title="Jump to Bottom">▼</button>

    <script>
        const vscode = acquireVsCodeApi();

        function handleScrollButtons() {
            const jumpToTopBtn = document.getElementById('jump-to-top-btn');
            const jumpToBottomBtn = document.getElementById('jump-to-bottom-btn');
            if (!jumpToTopBtn || !jumpToBottomBtn) return;

            const scrollHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;
            const scrollY = window.scrollY;
            const scrollThreshold = 50; // A small buffer

            // Only show buttons if the content is scrollable
            if (scrollHeight > clientHeight) {
                // "Jump to Top" button
                jumpToTopBtn.style.display = (scrollY > scrollThreshold) ? 'flex' : 'none';

                // "Jump to Bottom" button
                const atBottom = scrollY >= (scrollHeight - clientHeight - scrollThreshold);
                jumpToBottomBtn.style.display = atBottom ? 'none' : 'flex';
            } else {
                jumpToTopBtn.style.display = 'none';
                jumpToBottomBtn.style.display = 'none';
            }
        }

        let appState = {
            activeInstanceId: null,
            instances: [],
        };

        const suggestionState = {
            suggestions: [],
            selectedIndex: -1,
        };

        let focusState = {
            index: null,
            cursor: null
        };

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        const debouncedUpdate = debounce((index, newContent) => {
            vscode.postMessage({
                type: 'updateTextContext',
                index: index,
                context: newContent
            });
        }, 500);

        function updateWebSearchUI(isEnabled) {
            const webSearchToggle = document.getElementById('web-search-toggle');
            const searchStatus = document.getElementById('search-status');
            if (isEnabled) {
                webSearchToggle.classList.add('active');
                searchStatus.textContent = 'Web search: ON';
            } else {
                webSearchToggle.classList.remove('active');
                searchStatus.textContent = 'Web search: OFF';
            }
        }

        function hideSuggestions(index) {
            const suggestionBox = document.getElementById(`suggestion-box-${index}`);
            if (suggestionBox) {
                suggestionBox.style.display = 'none';
                suggestionBox.innerHTML = '';
            }
            suggestionState.suggestions = [];
            suggestionState.selectedIndex = -1;
        }

        function handleTextareaInput(event) {
            const textarea = event.target;
            const index = parseInt(textarea.dataset.index, 10);

            // auto-resize
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';

            debouncedUpdate(index, textarea.value);

            const value = textarea.value;
            const cursorPosition = textarea.selectionStart;
            const atIndex = value.lastIndexOf('@', cursorPosition - 1);

            if (atIndex !== -1) {
                const textAfterAt = value.substring(atIndex + 1, cursorPosition);
                if (!/\s/.test(textAfterAt)) { // Don't trigger if there's a space after @
                    vscode.postMessage({ type: 'getLocalFiles', query: textAfterAt, index });
                    return;
                }
            }
            hideSuggestions(index);
        }

        function handleTextareaKeydown(event) {
            const textarea = event.target;
            const index = parseInt(textarea.dataset.index, 10);
            const suggestionBox = document.getElementById(`suggestion-box-${index}`);

            if (suggestionBox.style.display !== 'block' || suggestionState.suggestions.length === 0) {
                return;
            }

            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    suggestionState.selectedIndex = (suggestionState.selectedIndex + 1) % suggestionState.suggestions.length;
                    updateSelectedSuggestion(index);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    suggestionState.selectedIndex = (suggestionState.selectedIndex - 1 + suggestionState.suggestions.length) % suggestionState.suggestions.length;
                    updateSelectedSuggestion(index);
                    break;
                case 'Tab':
                case 'Enter':
                    event.preventDefault();
                    if (suggestionState.selectedIndex !== -1) {
                        acceptSuggestion(textarea, suggestionState.suggestions[suggestionState.selectedIndex]);
                    }
                    break;
                case 'Escape':
                    event.preventDefault();
                    hideSuggestions(index);
                    break;
            }
        }

        function updateSelectedSuggestion(index) {
            const suggestionBox = document.getElementById(`suggestion-box-${index}`);
            const items = suggestionBox.children;
            for (let i = 0; i < items.length; i++) {
                if (i === suggestionState.selectedIndex) {
                    items[i].classList.add('selected');
                    items[i].scrollIntoView({ block: 'nearest' });
                } else {
                    items[i].classList.remove('selected');
                }
            }
        }

        function acceptSuggestion(textarea, filePath) {
            const index = parseInt(textarea.dataset.index, 10);
            const value = textarea.value;
            const cursorPosition = textarea.selectionStart;
            const atIndex = value.lastIndexOf('@', cursorPosition - 1);

            if (atIndex === -1) return;


            const textBefore = value.substring(0, atIndex);
            const textAfter = value.substring(cursorPosition);
            const newTextContent = `${textBefore}@${filePath} ${textAfter}`;
            const newCursorPos = (textBefore + '@' + filePath + ' ').length;

            textarea.value = newTextContent;
            hideSuggestions(index);

            focusState = {
                index: index,
                cursor: newCursorPos
            }

            vscode.postMessage({
                type: 'updateTextContext',
                index: index,
                context: newTextContent
            });

            vscode.postMessage({ type: 'addFileToContext', filePath: filePath });
        }

        function renderTabs() {
            const tabsList = document.getElementById('tabs-list');
            tabsList.innerHTML = '';

            appState.instances.forEach(instance => {
                const li = document.createElement('li');
                li.className = 'tab-item';
                li.dataset.id = instance.id;
                if (instance.id === appState.activeInstanceId) {
                    li.classList.add('active');
                }

                const nameSpan = document.createElement('span');
                nameSpan.className = 'tab-name';
                nameSpan.textContent = instance.name;

                li.appendChild(nameSpan);

                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-tab-btn';
                closeBtn.innerHTML = '&times;';
                closeBtn.title = 'Close Tab';
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    vscode.postMessage({ type: 'removeInstance', instanceId: instance.id });
                });
                li.appendChild(closeBtn);

                li.addEventListener('click', () => {
                    if (instance.id !== appState.activeInstanceId) {
                        vscode.postMessage({ type: 'switchInstance', instanceId: instance.id });
                    }
                });

                nameSpan.addEventListener('dblclick', () => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = nameSpan.textContent;
                    input.className = 'tab-name-input';
                    li.replaceChild(input, nameSpan);
                    input.focus();

                    const finishEditing = () => {
                        const newName = input.value.trim();
                        if (newName && newName !== instance.name) {
                            vscode.postMessage({ type: 'renameInstance', instanceId: instance.id, newName });
                        } else {
                            // No change, just revert
                            li.replaceChild(nameSpan, input);
                        }
                    };
                    input.addEventListener('blur', finishEditing);
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            finishEditing();
                        } else if (e.key === 'Escape') {
                            li.replaceChild(nameSpan, input); // Cancel edit
                        }
                    });
                });

                tabsList.appendChild(li);
            });
        }

        function renderContextList(context, mainContextIndex) {
            const contextList = document.getElementById('context-list');
            while (contextList.firstChild) {
                contextList.removeChild(contextList.firstChild);
            }

            if (context.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = `
            <div class="icon">📋</div>
            <div>No context items yet</div>
            <div style="font-size: 12px; margin-top: 4px; opacity: 0.7;">Add files, URLs, or text to get started</div>
            `;
                contextList.appendChild(emptyDiv);
                return;
            }

            context.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'context-item';
                if (index === mainContextIndex) {
                    li.classList.add('main-context');
                }
                if (item.ignored) {
                    li.classList.add('ignored');
                }

                const contentDiv = document.createElement('div');
                contentDiv.className = 'item-content';

                if (item.type !== 'Text') {
                    const wrapper = document.createElement('div');
                    wrapper.style.display = 'flex';
                    wrapper.style.alignItems = 'center';
                    wrapper.style.width = '100%';

                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'item-header';
                    headerDiv.style.flexGrow = '1';
                    headerDiv.style.minWidth = '0';

                    const badge = document.createElement('span');
                    badge.className = `item-badge badge-${item.type.toLowerCase()}`;
                    badge.textContent = item.type;
                    headerDiv.appendChild(badge);

                    const sourceSpan = document.createElement('span');
                    sourceSpan.className = item.type === 'File' ? 'item-source' : 'web-item-source';
                    sourceSpan.textContent = item.context;
                    sourceSpan.title = item.context;
                    headerDiv.appendChild(sourceSpan);

                    wrapper.appendChild(headerDiv);

                    const btnCol = document.createElement('div');
                    btnCol.className = 'btn-col';
                    btnCol.style.marginLeft = '8px';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.title = 'Remove item';
                    deleteBtn.addEventListener('click', () => {
                        vscode.postMessage({ type: 'removeContext', index: index });
                    });

                    btnCol.appendChild(deleteBtn);
                    wrapper.appendChild(btnCol);
                    contentDiv.appendChild(wrapper);
                }

                if (item.type === 'Text') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'suggestion-wrapper';
                    wrapper.style.display = 'flex';
                    wrapper.style.alignItems = 'flex-start';

                    const suggestionBox = document.createElement('div');
                    suggestionBox.className = 'suggestion-box';
                    suggestionBox.id = `suggestion-box-${index}`;

                    const textarea = document.createElement('textarea');
                    textarea.className = 'editable-text';
                    textarea.value = item.context;
                    textarea.placeholder = "Type '@' to mention a file...";
                    textarea.dataset.index = index;

                    wrapper.appendChild(suggestionBox);
                    wrapper.appendChild(textarea);

                    // Button column (vertical)
                    const btnCol = document.createElement('div');
                    btnCol.className = 'btn-col';

                    // Main (star) button
                    const mainBtn = document.createElement('button');
                    mainBtn.className = 'main-btn';
                    mainBtn.title = index === mainContextIndex ? 'Unset as main context' : 'Set as main context';
                    mainBtn.innerHTML = index === mainContextIndex
                        ? '★'
                        : '☆';
                    mainBtn.setAttribute('aria-pressed', index === mainContextIndex ? 'true' : 'false');
                    mainBtn.addEventListener('click', () => {
                        vscode.postMessage({ type: 'setMainContext', index: index });
                    });

                    // Show star always if main, else only on hover
                    if (index === mainContextIndex) {
                        mainBtn.classList.add('main-active');
                    }

                    // Delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.title = 'Remove item';
                    deleteBtn.addEventListener('click', () => {
                        vscode.postMessage({ type: 'removeContext', index: index });
                    });

                    // Ignore (eye) button
                    const ignoreBtn = document.createElement('button');
                    ignoreBtn.className = 'ignore-btn';
                    ignoreBtn.title = item.ignored ? 'Include this context' : 'Ignore this context';
                    ignoreBtn.innerHTML = item.ignored ? '🙈' : '👁️';
                    if (item.ignored) {
                        ignoreBtn.classList.add('ignored-active');
                    }
                    ignoreBtn.addEventListener('click', () => {
                        vscode.postMessage({ type: 'toggleIgnoreContext', index: index });
                    });

                    btnCol.appendChild(mainBtn);
                    btnCol.appendChild(ignoreBtn);
                    btnCol.appendChild(deleteBtn);

                    btnCol.style.display = 'flex';
                    btnCol.style.flexDirection = 'column';
                    btnCol.style.alignItems = 'flex-end';
                    btnCol.style.marginLeft = '8px';
                    btnCol.style.height = '100%';

                    wrapper.appendChild(btnCol);
                    contentDiv.appendChild(wrapper);

                    textarea.addEventListener('input', handleTextareaInput);
                    textarea.addEventListener('keydown', handleTextareaKeydown);
                    textarea.addEventListener('blur', () => hideSuggestions(index));

                    setTimeout(() => {
                        textarea.style.height = 'auto';
                        textarea.style.height = (textarea.scrollHeight) + 'px';
                    }, 0);
                }

                li.appendChild(contentDiv);
                contextList.appendChild(li);
            });
            updateStats(context.length);
            setTimeout(handleScrollButtons, 150); // Check scroll button visibility after render
        }

        // Redefine updateContextList to call both renderContextList and sync the tree
        function updateContextList(context, mainContextIndex) {
            if (!Array.isArray(context)) return;
            renderContextList(context, mainContextIndex);
            currentFileContextPaths = new Set(
                context.filter(item => item.type === 'File').map(item => item.context)
            );
            syncTreeCheckboxes();
        }

        function updateStats(count) {
            const statsDiv = document.querySelector('.stats');
            if (statsDiv) {
                const countSpan = statsDiv.querySelector('span:first-child');
                countSpan.textContent = `${count} context item${count !== 1 ? 's' : ''}`;
            }
        }

        let currentFileContextPaths = new Set();

        function renderTreeView(tree) {
            const ul = document.createElement('ul');
            ul.className = 'tree-list';

            tree.forEach(node => {
                const li = document.createElement('li');
                li.className = `tree-item ${node.type}`;
                li.dataset.path = node.path;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'tree-item-content';

                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.path = node.path;

                const iconSpan = document.createElement('span');
                iconSpan.className = 'tree-icon';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'tree-item-name';
                nameSpan.textContent = node.name;
                nameSpan.title = node.name;

                label.appendChild(checkbox);
                label.appendChild(iconSpan);
                label.appendChild(nameSpan);
                contentDiv.appendChild(label);
                li.appendChild(contentDiv);

                if (node.type === 'file') {
                    checkbox.checked = currentFileContextPaths.has(node.path);
                }

                if (node.type === 'folder') {
                    contentDiv.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            e.preventDefault();
                            li.classList.toggle('open');
                        }
                    });

                    if (node.children && node.children.length > 0) {
                        const childrenUl = renderTreeView(node.children);
                        childrenUl.classList.add('tree-children');
                        li.appendChild(childrenUl);
                    }
                }
                ul.appendChild(li);
            });

            return ul;
        }

        function handleTreeCheckboxChange(e) {
            const checkbox = e.target;
            if (checkbox.tagName !== 'INPUT' || checkbox.type !== 'checkbox') return;

            const li = checkbox.closest('.tree-item');
            const isChecked = checkbox.checked;

            const filesToUpdate = [];

            // Recursively find all file checkboxes within a folder
            const collectFiles = (element) => {
                const childCheckboxes = element.querySelectorAll('.tree-item.file input[type="checkbox"]');
                childCheckboxes.forEach(cb => filesToUpdate.push({ path: cb.dataset.path, checked: isChecked }));
            };

            if (li.classList.contains('folder')) {
                // Collect all child files and check/uncheck them
                const childCheckboxes = li.querySelectorAll('input[type="checkbox"]');
                childCheckboxes.forEach(cb => cb.checked = isChecked);
                collectFiles(li);
            } else {
                filesToUpdate.push({ path: li.dataset.path, checked: isChecked });
            }

            // Send messages to the extension for each file
            filesToUpdate.forEach(file => {
                if (file.checked) {
                    vscode.postMessage({ type: 'addFileToContext', filePath: file.path });
                } else {
                    vscode.postMessage({ type: 'removeFileFromContext', filePath: file.path });
                }
            });
        }

        function syncTreeCheckboxes() {
            const allCheckboxes = document.querySelectorAll('#project-tree-container input[type="checkbox"]');
            allCheckboxes.forEach(cb => {
                const path = cb.dataset.path;
                if (path) {
                    cb.checked = currentFileContextPaths.has(path);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const addFileBtn = document.getElementById('add-file-btn');
            const addUrlBtn = document.getElementById('add-url-btn');
            const addTextBtn = document.getElementById('add-text-btn');
            const webSearchToggle = document.getElementById('web-search-toggle');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const copyAllBtn = document.getElementById('copy-all-btn');
            const geminiBtn = document.getElementById('gemini-btn');
            const glmBtn = document.getElementById('glm-btn');
            const projectTreeContainer = document.getElementById('project-tree-container');
            const jumpToTopBtn = document.getElementById('jump-to-top-btn');
            const jumpToBottomBtn = document.getElementById('jump-to-bottom-btn');

            addFileBtn.addEventListener('click', () => vscode.postMessage({ type: 'addFile' }));
            addUrlBtn.addEventListener('click', () => vscode.postMessage({ type: 'addUrl' }));
            addTextBtn.addEventListener('click', () => vscode.postMessage({ type: 'addText' }));
            clearAllBtn.addEventListener('click', () => vscode.postMessage({ type: 'clearContext' }));
            copyAllBtn.addEventListener('click', () => vscode.postMessage({ type: 'copyAllContext' }));

            geminiBtn.addEventListener('click', () => {
                vscode.postMessage({ type: 'openUrl', url: 'https://aistudio.google.com/prompts/new_chat?hl=de', pasteDelay: 1500 });
            });
            glmBtn.addEventListener('click', () => {
                vscode.postMessage({ type: 'openUrl', url: 'https://chat.z.ai/', pasteDelay: 6000 });  // don't know why, but they take forever to open
            });

            projectTreeContainer.addEventListener('change', handleTreeCheckboxChange);

            jumpToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            jumpToBottomBtn.addEventListener('click', () => {
                window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
            });

            window.addEventListener('scroll', handleScrollButtons);
            window.addEventListener('resize', handleScrollButtons);

            webSearchToggle.addEventListener('click', () => {
                const activeInstance = appState.instances.find(i => i.id === appState.activeInstanceId);
                if (activeInstance) {
                    const newEnabledState = !activeInstance.webSearchEnabled;
                    updateWebSearchUI(newEnabledState);
                    vscode.postMessage({ type: 'toggleWebSearch', enabled: newEnabledState });
                }
            });

            document.getElementById('add-tab-btn').addEventListener('click', () => {
                vscode.postMessage({ type: 'addInstance' });
            });

            window.addEventListener('message', event => {
                const message = event.data;
                switch (message.type) {
                    case 'updateState':
                        appState = message.state;
                        renderTabs();
                        const activeInstance = appState.instances.find(i => i.id === appState.activeInstanceId);
                        if (activeInstance) {
                            updateContextList(activeInstance.context, activeInstance.mainContextIndex);
                            updateWebSearchUI(activeInstance.webSearchEnabled);
                        } else {
                            updateContextList([], -1);
                            updateWebSearchUI(false);
                        }
                        break;
                    case 'fileSuggestions':
                        {
                            const { suggestions, index } = message;
                            const suggestionBox = document.getElementById(`suggestion-box-${index}`);
                            if (suggestionBox) {
                                suggestionBox.innerHTML = '';
                                if (suggestions.length > 0) {
                                    suggestionState.suggestions = suggestions;
                                    suggestionState.selectedIndex = 0;
                                    suggestions.forEach((file, i) => {
                                        const item = document.createElement('div');
                                        item.className = 'suggestion-item';
                                        item.textContent = file;
                                        item.title = file;
                                        item.addEventListener('mousedown', (e) => {
                                            e.preventDefault();
                                            const textarea = document.querySelector(`textarea[data-index="${index}"]`);
                                            acceptSuggestion(textarea, file);
                                        });
                                        suggestionBox.appendChild(item);
                                    });
                                    updateSelectedSuggestion(index);
                                    suggestionBox.style.display = 'block';
                                } else {
                                    hideSuggestions(index);
                                }
                            }
                            break;
                        }
                    case 'workspaceTree': {
                        const tree = message.tree;
                        const treeElement = renderTreeView(tree, projectTreeContainer);
                        projectTreeContainer.innerHTML = '';
                        projectTreeContainer.appendChild(treeElement);
                        syncTreeCheckboxes();
                        break;
                    }
                }
            });

            vscode.postMessage({ type: 'requestUpdate' });
            vscode.postMessage({ type: 'getWorkspaceTree' });

            setTimeout(handleScrollButtons, 1000);
        });
    </script>
</body>

</html>